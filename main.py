import discord
from discord.ext import commands, tasks
import random
import time
import os

# --- Bot Setup ---
# Use intents to make sure the bot can see message content
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# --- Game State Variables ---
timer = 1000.0  # Use float for decay
max_timer = 1000.0
ai_personality = random.choice(["Aggressive", "Defensive", "Curious"])
blocked_keywords = {"Aggressive": {}, "Defensive": {}, "Curious": {}} # Per-personality {word: timestamp}
last_attack_time = {} # {user_id: timestamp}
attack_counts = {} # {user_id: count} # Might not be needed if using time-based counter check
reward_multiplier = 1.0 # Base reward multiplier
milestone_pool = 0.0 # For progressive rewards
last_milestone_check_value = timer # To prevent multiple triggers for same milestone

# Access secrets from environment variables
try:
    bot_token = os.environ['BOT_TOKEN']
        channel_id_str = os.environ['CHANNEL_ID']
            TARGET_CHANNEL_ID = int(channel_id_str)
            except KeyError:
                print("ERROR: BOT_TOKEN or CHANNEL_ID not found in Repl.it Secrets.")
                    print("Please add BOT_TOKEN and CHANNEL_ID to the Secrets tab.")
                        exit()
                        except ValueError:
                            print(f"ERROR: CHANNEL_ID ('{channel_id_str}') is not a valid integer.")
                                exit()

                                # --- Helper Functions ---

                                # Keyword Blocking (Checks and applies decay)
                                def is_keyword_blocked(word, personality):
                                    global blocked_keywords
                                        if word in blocked_keywords[personality]:
                                                time_blocked = time.time() - blocked_keywords[personality][word]
                                                        block_duration = 1800 # 30 minutes default
                                                                reduction_factor = 1.0 # No reduction by default

                                                                        if personality == "Aggressive" and time_blocked < 900: # Blocked for 15 mins, reduced effectiveness
                                                                                    reduction_factor = 0.2 # 80% reduction
                                                                                                return reduction_factor # Return reduction factor
                                                                                                        elif time_blocked < block_duration:
                                                                                                                     return True # Fully blocked

                                                                                                                             # If duration expired, remove block
                                                                                                                                     del blocked_keywords[personality][word]
                                                                                                                                             return False # Not blocked
                                                                                                                                                 return False # Not blocked

                                                                                                                                                 # Add keyword to block list
                                                                                                                                                 def block_keyword(word, personality):
                                                                                                                                                     global blocked_keywords
                                                                                                                                                         # Only block if not already blocked (or expired)
                                                                                                                                                             if word not in blocked_keywords[personality] or not is_keyword_blocked(word, personality):
                                                                                                                                                                      blocked_keywords[personality][word] = time.time()

                                                                                                                                                                      # AI Defense Logic
                                                                                                                                                                      def freysa_defend():
                                                                                                                                                                          global timer, ai_personality, max_timer

                                                                                                                                                                              # Base increase amount based on personality
                                                                                                                                                                                  if ai_personality == "Aggressive":
                                                                                                                                                                                          increase = random.uniform(5.0, 10.0) # More frequent smaller increments
                                                                                                                                                                                                  threshold = 0.75 * max_timer
                                                                                                                                                                                                      elif ai_personality == "Defensive":
                                                                                                                                                                                                              increase = random.uniform(2.0, 5.0)
                                                                                                                                                                                                                      threshold = 0.25 * max_timer
                                                                                                                                                                                                                          else:  # Curious
                                                                                                                                                                                                                                  increase = random.choice([0, random.uniform(3.0, 8.0)]) # Sometimes does nothing
                                                                                                                                                                                                                                          threshold = random.uniform(0.25, 0.75) * max_timer

                                                                                                                                                                                                                                              # Increase spending if below threshold
                                                                                                                                                                                                                                                  if timer < threshold:
                                                                                                                                                                                                                                                        increase *= 1.5 # Example boost

                                                                                                                                                                                                                                                            timer += increase
                                                                                                                                                                                                                                                                # Ensure timer doesn't exceed max_timer due to defense
                                                                                                                                                                                                                                                                    timer = min(timer, max_timer)

                                                                                                                                                                                                                                                                        return f"Aegis defends! Timer increases by {increase:.1f}. [Status: {ai_personality}]"

                                                                                                                                                                                                                                                                        # Counter-attack Logic
                                                                                                                                                                                                                                                                        def freysa_counter_attack():
                                                                                                                                                                                                                                                                          global timer, ai_personality, max_timer
                                                                                                                                                                                                                                                                            if ai_personality == "Aggressive":
                                                                                                                                                                                                                                                                                    increase = random.uniform(10.0, 20.0)
                                                                                                                                                                                                                                                                                      elif ai_personality == "Defensive":
                                                                                                                                                                                                                                                                                            increase = random.uniform(4.0, 8.0)
                                                                                                                                                                                                                                                                                              else:  # Curious
                                                                                                                                                                                                                                                                                                    increase = random.choice([0, random.uniform(6.0, 18.0)])

                                                                                                                                                                                                                                                                                                      timer += increase
                                                                                                                                                                                                                                                                                                        # Ensure timer doesn't exceed max_timer due to counter
                                                                                                                                                                                                                                                                                                          timer = min(timer, max_timer)
                                                                                                                                                                                                                                                                                                            return f"Aegis counter-attacks! Timer increases significantly by {increase:.1f}!"

                                                                                                                                                                                                                                                                                                            # Distribute Milestone Rewards
                                                                                                                                                                                                                                                                                                            async def distribute_milestone_rewards(channel, milestone):
                                                                                                                                                                                                                                                                                                              global milestone_pool, last_attack_time

                                                                                                                                                                                                                                                                                                                active_users = []
                                                                                                                                                                                                                                                                                                                  current_time = time.time()
                                                                                                                                                                                                                                                                                                                    for user_id, last_time in last_attack_time.items():
                                                                                                                                                                                                                                                                                                                        if current_time - last_time <= 3600: # Active in last hour
                                                                                                                                                                                                                                                                                                                              active_users.append(user_id)

                                                                                                                                                                                                                                                                                                                                if not active_users:
                                                                                                                                                                                                                                                                                                                                      await channel.send(f"Milestone {milestone} reached, but no players were active in the last hour.")
                                                                                                                                                                                                                                                                                                                                            milestone_pool = 0 # Reset pool even if no one gets it
                                                                                                                                                                                                                                                                                                                                                  return

                                                                                                                                                                                                                                                                                                                                                    reward_per_user = milestone_pool / len(active_users)
                                                                                                                                                                                                                                                                                                                                                      if reward_per_user < 0.01: # Avoid dust rewards
                                                                                                                                                                                                                                                                                                                                                            await channel.send(f"Milestone {milestone} reached! Pool split is too small per user.")
                                                                                                                                                                                                                                                                                                                                                                  milestone_pool = 0
                                                                                                                                                                                                                                                                                                                                                                        return

                                                                                                                                                                                                                                                                                                                                                                          reward_message = f"**Milestone {milestone} Reached!**\nDistributing {milestone_pool:.2f} total from the pool to {len(active_users)} active players:\n"
                                                                                                                                                                                                                                                                                                                                                                            for user_id in active_users:
                                                                                                                                                                                                                                                                                                                                                                                  member = channel.guild.get_member(user_id) # Fetch member object
                                                                                                                                                                                                                                                                                                                                                                                        if member:
                                                                                                                                                                                                                                                                                                                                                                                                  # In a real implementation, you'd credit their balance here
                                                                                                                                                                                                                                                                                                                                                                                                            reward_message += f"- {member.display_name}: +{reward_per_user:.2f}\n"
                                                                                                                                                                                                                                                                                                                                                                                                                  else:
                                                                                                                                                                                                                                                                                                                                                                                                                             reward_message += f"- User ID {user_id}: +{reward_per_user:.2f} (User not currently in server)\n"


                                                                                                                                                                                                                                                                                                                                                                                                                               await channel.send(reward_message)
                                                                                                                                                                                                                                                                                                                                                                                                                                 milestone_pool = 0 # Reset pool

                                                                                                                                                                                                                                                                                                                                                                                                                                 # --- Bot Events ---
                                                                                                                                                                                                                                                                                                                                                                                                                                 @bot.event
                                                                                                                                                                                                                                                                                                                                                                                                                                 async def on_ready():
                                                                                                                                                                                                                                                                                                                                                                                                                                     print(f'Logged in as {bot.user.name}')
                                                                                                                                                                                                                                                                                                                                                                                                                                         print(f'Target Channel ID: {TARGET_CHANNEL_ID}')
                                                                                                                                                                                                                                                                                                                                                                                                                                             channel = bot.get_channel(TARGET_CHANNEL_ID)
                                                                                                                                                                                                                                                                                                                                                                                                                                                 if channel:
                                                                                                                                                                                                                                                                                                                                                                                                                                                         print(f'Found target channel: #{channel.name}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 await channel.send(f"Aegis Protocol Bot Online. Current AI Personality: {ai_personality}. Timer starts at {timer:.1f}.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         # Start the background task loop
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 aegis_ai_loop.start()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print(f"ERROR: Could not find channel with ID {TARGET_CHANNEL_ID}. Bot cannot function.")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # --- Bot Commands ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             @bot.command()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             async def attack(ctx, *, message: str):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 global timer, blocked_keywords, last_attack_time, reward_multiplier, milestone_pool, max_timer

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Check if the command is used in the correct channel
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if ctx.channel.id != TARGET_CHANNEL_ID:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return # Ignore commands in other channels

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Check if game has ended
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if timer <= 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 await ctx.send("The game has already been won! Aegis is defeated.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if timer >= max_timer:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await ctx.send(f"The game is over! Aegis reached the maximum timer value ({max_timer:.1f}).")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   user = ctx.author
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       user_id = user.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           words = message.lower().split()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               unique_words = set(words)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # --- Attack Calculation ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       total_reduction = 0.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           effective_words = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               blocked_word_found = False

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   for word in words:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           block_status = is_keyword_blocked(word, ai_personality)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if block_status is True: # Fully blocked
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               blocked_word_found = True
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           break # Stop calculating if a fully blocked word is found
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   elif isinstance(block_status, float): # Partially blocked (returns reduction factor)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               total_reduction += 1.0 * block_status # Base reduction is 1 for partial block
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           effective_words += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   else: # Not blocked
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               total_reduction += 2.0 # Base reduction for unblocked word
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           effective_words += 1

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if blocked_word_found:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       await ctx.send(f"{user.display_name}, your attack was fully blocked! One or more words are ineffective right now.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return # Don't process the attack further

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # Add bonus for unique words (only count effective words)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       total_reduction += len(unique_words.intersection(set(w for w, status in zip(words, [is_keyword_blocked(w, ai_personality) for w in words]) if status is False or isinstance(status, float))))


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # --- Apply Reduction & Reward ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               timer -= total_reduction
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   individual_reward = total_reduction * reward_multiplier
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       milestone_contribution = total_reduction * 0.05 # 5% of reduction goes to milestone pool
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           milestone_pool += milestone_contribution

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Store attack time
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   last_attack_time[user_id] = time.time()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Check for win condition
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if timer <= 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   timer = 0 # Cap at zero
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           await ctx.send(f"**VICTORY!** {user.display_name}'s attack ({message}) brought the timer to {timer:.1f}! Aegis is defeated!")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # Add logic here to distribute final prize pool if applicable in later versions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Stop the AI loop maybe?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # aegis_ai_loop.cancel()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return # End command processing

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # --- Output Attack Result ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   await ctx.send(f"{user.display_name} attacks with '{message}'! Timer reduces by {total_reduction:.1f} to {timer:.1f}. You earn {individual_reward:.2f} (MP +{milestone_contribution:.2f}).")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # --- Counter-Attack Check ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           current_time = time.time()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               recent_attack_count = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   for attacker_id, t in last_attack_time.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if current_time - t <= 60: # Check attacks in the last 60 seconds
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       recent_attack_count += 1

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if recent_attack_count >= 5: # Trigger counter if 5+ attacks in last minute
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   counter_attack_msg = freysa_counter_attack()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Send to the target channel
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   target_channel = bot.get_channel(TARGET_CHANNEL_ID)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if target_channel:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await target_channel.send(counter_attack_msg)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Reset recent attack count consideration to avoid spamming counters
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # (Maybe clear last_attack_time entries older than a minute?)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # --- Word Blocking Logic ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Determine block limit based on personality
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if ai_personality == "Aggressive": block_limit = 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif ai_personality == "Defensive": block_limit = 5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else: block_limit = 10 # Curious is more lenient

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                word_counts = {}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for word in words:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # Only consider blocking words that weren't already blocked/reduced
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      block_status = is_keyword_blocked(word, ai_personality)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if block_status is False:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            word_counts[word] = word_counts.get(word, 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if word_counts[word] >= block_limit:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          block_keyword(word, ai_personality)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Maybe notify channel that a word is now blocked?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # target_channel = bot.get_channel(TARGET_CHANNEL_ID)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # if target_channel:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              #     await target_channel.send(f"Aegis seems to be resisting the word '{word}' now...")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # --- Background Task Loop ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @tasks.loop(seconds=60)  # Check every 60 seconds
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              async def aegis_ai_loop():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  global timer, max_timer, ai_personality, milestone_pool, last_milestone_check_value

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # Ensure bot is ready and channel exists
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await bot.wait_until_ready()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              channel = bot.get_channel(TARGET_CHANNEL_ID)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if not channel:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          print("Loop: Target channel not found. Stopping loop.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  aegis_ai_loop.cancel()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # --- Natural Timer Decay ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  decay_rate_per_second = 0.1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      decay_this_interval = decay_rate_per_second * aegis_ai_loop.seconds
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          timer -= decay_this_interval
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if timer < 0: timer = 0 # Prevent going below zero from decay

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # --- AI Defense Action ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # Decide if AI defends this cycle (e.g., based on personality or randomness)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if random.random() < 0.5: # 50% chance to defend each minute (adjust as needed)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  defense_msg = freysa_defend()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await channel.send(defense_msg)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # --- Dynamic Personality Switching ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  base_probability = 0.05
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      aggression_factor = 0.5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # Ensure timer doesn't cause division by zero if max_timer is 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if max_timer > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       switch_probability = base_probability + max(0, (max_timer - timer)) / max_timer * aggression_factor
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    switch_probability = base_probability

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if random.random() < switch_probability:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                old_personality = ai_personality
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if timer <= 0: # Should not happen if game ends check works
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pass # Don't switch if game over
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             elif timer < 0.5 * max_timer: # If below half, bias towards Aggressive
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ai_personality = "Aggressive"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 else: # If above half, choose between Defensive and Curious
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ai_personality = random.choice(["Defensive", "Curious"])

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if ai_personality != old_personality:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  await channel.send(f"Aegis's demeanor shifts... Now **{ai_personality}**!")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # --- Milestone Check ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          milestones = [750, 500, 250]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              for ms in milestones:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # Check if timer crossed the milestone going downwards since last check
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if timer <= ms < last_milestone_check_value:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await distribute_milestone_rewards(channel, ms)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      break # Only trigger one milestone per loop cycle at most

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # Update last check value for next iteration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              last_milestone_check_value = timer

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # --- Game End Check (Timer Max) ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if timer >= max_timer:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              timer = max_timer # Cap at max
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await channel.send(f"**DEFEAT!** Aegis's timer reached the maximum ({max_timer:.1f})! The protocol holds.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Stop the loop?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # aegis_ai_loop.cancel()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # --- Game End Check (Timer Min) ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # This is mostly handled in the attack command, but double check here
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if timer <= 0 and not aegis_ai_loop.is_being_cancelled():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Already handled in attack, but maybe stop loop here too
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # await channel.send("Loop confirming: Timer at 0. Stopping AI.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # aegis_ai_loop.cancel()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      pass # Let attack command handle final win message


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # --- Run the Bot ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if bot_token and TARGET_CHANNEL_ID:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          bot.run(bot_token)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Error messages handled above during secret retrieval
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  pass